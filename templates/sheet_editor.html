<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">{{ sheet.sheet_name }}</h5>
        <div>
            <button class="btn btn-sm btn-outline-secondary" id="toggleFormatPanel">
                <i class="bi bi-brush"></i> Format
            </button>
            <button class="btn btn-sm btn-outline-primary" id="addRowBtn">
                <i class="bi bi-plus-lg"></i> Add Row
            </button>
            <button class="btn btn-sm btn-outline-primary" id="addColumnBtn">
                <i class="bi bi-plus-lg"></i> Add Column
            </button>
        </div>
    </div>
    
    <!-- Formatting Panel (initially hidden) -->
    <div class="formatting-panel p-2 bg-light border-bottom" style="display: none;">
        <div class="row g-2">
            <!-- Text Formatting -->
            <div class="col-auto">
                <div class="btn-group" role="group" aria-label="Text formatting">
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="boldBtn" title="Bold">
                        <i class="bi bi-type-bold"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="italicBtn" title="Italic">
                        <i class="bi bi-type-italic"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="underlineBtn" title="Underline">
                        <i class="bi bi-type-underline"></i>
                    </button>
                </div>
            </div>
            
            <!-- Alignment -->
            <div class="col-auto">
                <div class="btn-group" role="group" aria-label="Text alignment">
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="alignLeftBtn" title="Align Left">
                        <i class="bi bi-text-left"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="alignCenterBtn" title="Align Center">
                        <i class="bi bi-text-center"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="alignRightBtn" title="Align Right">
                        <i class="bi bi-text-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Cell Operations -->
            <div class="col-auto">
                <div class="btn-group" role="group" aria-label="Cell operations">
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="mergeCellsBtn" title="Merge Cells">
                        <i class="bi bi-grid-3x2"></i> Merge
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="divideCellBtn" title="Divide Cell">
                        <i class="bi bi-grid-3x2-gap"></i> Divide
                    </button>
                </div>
            </div>
            
            <!-- Row/Column Operations -->
            <div class="col-auto">
                <div class="btn-group" role="group" aria-label="Row/Column operations">
                    <button type="button" class="btn btn-sm btn-outline-danger" id="deleteRowBtn" title="Delete Row">
                        <i class="bi bi-dash-circle"></i> Row
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger" id="deleteColumnBtn" title="Delete Column">
                        <i class="bi bi-dash-circle"></i> Column
                    </button>
                </div>
            </div>
            
            <!-- Header/Cell Color -->
            <div class="col-auto">
                <div class="btn-group" role="group" aria-label="Colors">
                    <button type="button" class="btn btn-sm btn-outline-warning" id="headerColorBtn" title="Header Color">
                        <i class="bi bi-palette"></i> Header
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-info" id="bgColorBtn" title="Background Color">
                        <i class="bi bi-palette2"></i> Cell
                    </button>
                    <input type="color" id="bgColorPicker" class="d-none">
                </div>
            </div>
            
            <!-- Formula Operations -->
            <div class="col-auto">
                <div class="btn-group" role="group" aria-label="Formula operations">
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="columnFormulaBtn" title="Column Formula">
                        <i class="bi bi-calculator"></i> Col Formula
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="rowFormulaBtn" title="Row Formula">
                        <i class="bi bi-calculator"></i> Row Formula
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card-body p-0">
        <div class="table-responsive">
            <!-- Column headers for resizing -->
            <div class="excel-column-headers" id="columnHeaders">
                {% for header in data[0] %}
                <div class="excel-column-header" data-col="{{ loop.index0 }}">
                    {{ loop.index0|column_letter }}
                    <div class="col-resize-handle" data-col="{{ loop.index0 }}"></div>
                </div>
                {% endfor %}
            </div>
            
            <table class="table table-bordered mb-0 sheet-table" id="sheetTable" data-sheet-name="{{ sheet.sheet_name }}">
                <thead>
                    <tr>
                        {% for header in data[0] %}
                        <th class="sheet-header" data-col="{{ loop.index0 }}" style="width: 80px;">
                            <div class="editable-cell" contenteditable="true">{{ header }}</div>
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in data[1:] %}
                    {% set outer_loop = loop %}
                    <tr data-row="{{ loop.index0 }}" style="height: 25px;">
                        {% for cell in row %}
                        {% set row_index = outer_loop.index0 %}
                        {% set col_index = loop.index0 %}
                        {% set cell_ref = (65 + col_index)|char ~ (row_index + 2) %}
                        {% set cell_format = format_metadata[cell_ref]|default({}) if format_metadata else {} %}
                        <td class="sheet-cell" data-row="{{ row_index }}" data-col="{{ col_index }}">
                            <div class="editable-cell" contenteditable="true"
                                 {% if cell_format %}
                                 style="{{ cell_format.style|default('') }}"
                                 class="{{ cell_format.class|default('') }}"
                                 {% endif %}>
                                {{ cell }}
                            </div>
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Formula Input Dialog -->
<div class="formula-input" id="formulaInput">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Enter Formula</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label for="formulaInputField" class="form-label">Formula</label>
                <input type="text" class="form-control" id="formulaInputField" placeholder="e.g. =SUM(A1:A5)">
                <div class="form-text">Use cell references like A1, B2, etc.</div>
            </div>
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button type="button" class="btn btn-secondary" id="cancelFormulaBtn">Cancel</button>
                <button type="button" class="btn btn-primary" id="applyFormulaBtn">Apply</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast container for notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3"></div>

<script>
    // Initialize sheet editor
    document.addEventListener('DOMContentLoaded', function() {
        // Tooltip initialization
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
    });
</script>